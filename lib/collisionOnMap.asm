.segment "ZEROPAGE"
   isGravity: .res 1
   xOffset: .res 1
   nameTableLowByte: .res 1
   nameTableHighByte: .res 1
   collisionTmp: .res 1
   currentAdc: .res 1
   currentNameTable: .res 1
   fakeXCoordinate: .res 1
   collideDetection: .res 1 ; remove in to be

   collideX: .res 1
   collideY: .res 1
   collideFlag: .res 1

   collisionFirstLB: .res 1
   collisionSecondLB: .res 1

   collisionPart: .res 1

.segment "RODATA"

bit_mask:
  .byt %10000000
  .byt %01000000
  .byt %00100000
  .byt %00010000
  .byt %00001000
  .byt %00000100
  .byt %00000010
  .byt %00000001

map_level_1_collision_map_1_first:
  .byt %00000000, %00000011, %11111111, %11111000 ; 1 левая часть экрана
  .byt %00000000, %00000011, %11111111, %11111000 ; 2
  .byt %00000000, %00000011, %11111111, %11111000 ; 3
  .byt %00000000, %00000011, %11111111, %11111000 ; 5
  .byt %00000000, %00000011, %11111111, %11111000 ; 6
  .byt %00000000, %00000011, %11111111, %11111000 ; 7
  .byt %00000000, %00000011, %11111111, %11111000 ; 8
  .byt %00000000, %00000011, %11111111, %11111000 ; 9
  .byt %00000000, %00000011, %11111111, %11111000 ; 10
  .byt %00000000, %00000001, %11111111, %11111000 ; 11
  .byt %00000000, %00000000, %11111111, %11111000 ; 12
  .byt %00000000, %00000000, %01111111, %11111000 ; 13
  .byt %00000000, %00000000, %00111111, %11111000 ; 13
  .byt %00000000, %00000000, %00111111, %11111000 ; 14
  .byt %00000000, %00000000, %01111111, %11100000 ; 15
  .byt %00000000, %00000000, %11111111, %11111000 ; 16
  .byt %00000000, %00000001, %11111111, %11111000 ; 17
  .byt %00000000, %00000011, %11111111, %11111000 ; 18
  .byt %00000000, %00000011, %11111111, %11111000 ; 19
  .byt %00000000, %00000011, %00111111, %11111000 ; 20
  .byt %00000000, %00000011, %00111111, %11111000 ; 21
  .byt %00000000, %00000011, %00111111, %11111000 ; 22
  .byt %00000000, %00000011, %00111111, %11111000 ; 23
  .byt %00000000, %00000011, %00111111, %11111000 ; 24
  .byt %00000000, %00000011, %00111111, %11111000 ; 25
  .byt %00000000, %00000011, %00111111, %11111000 ; 26
  .byt %00000000, %00000000, %00111111, %11111000 ; 27
  .byt %00000000, %00000000, %00111111, %11111000 ; 28
  .byt %00000000, %00000000, %00111111, %11111000 ; 29
  .byt %00000000, %00000000, %00111111, %11111000 ; 30
  .byt %00000000, %00000000, %00111111, %11111000 ; 31
  .byt %00000000, %00000000, %00111111, %11111000 ; 32 правая часть экрана
map_level_1_collision_map_1_first_2:
  .byt %00000000, %00000000, %00111111, %11111000 ; 1
  .byt %00000000, %00000000, %00111111, %11111000 ; 2
  .byt %00000000, %00000000, %00111111, %10111000 ; 3
  .byt %00000000, %00000000, %00111111, %10111000 ; 5
  .byt %00000000, %00000000, %00000111, %10111000 ; 6
  .byt %00000000, %00000000, %00001111, %10111000 ; 7
  .byt %00000000, %00000000, %00111111, %11111000 ; 8
  .byt %00000000, %00000000, %00111111, %11111000 ; 9
  .byt %00000000, %00000000, %00111111, %11111000 ; 10
  .byt %00000000, %00000000, %00111111, %11111000 ; 11
  .byt %00000000, %00000000, %00111111, %11111000 ; 12
  .byt %00000000, %00000000, %00111111, %11111000 ; 13
  .byt %00000000, %00000000, %00111111, %11111000 ; 13
  .byt %00000000, %00000000, %00111111, %11111000 ; 14
  .byt %00000000, %00000000, %00111111, %11111000 ; 15
  .byt %00000000, %00000000, %00111111, %11111000 ; 16
  .byt %00000000, %00000000, %00111111, %11111000 ; 17
  .byt %00000000, %00000000, %00111111, %11111000 ; 18
  .byt %00000000, %00000000, %00111111, %11111000 ; 19
  .byt %00000000, %00000000, %00111111, %11111000 ; 20
  .byt %00000000, %00000000, %00111111, %11111000 ; 21
  .byt %00000000, %00000000, %00111111, %11111000 ; 22
  .byt %00000000, %00000000, %00111111, %11111000 ; 23
  .byt %00000000, %00000000, %00111111, %11111000 ; 24
  .byt %00000000, %00000000, %00111111, %11111000 ; 25
  .byt %00000000, %00000000, %00111111, %11111000 ; 26
  .byt %00000000, %00000000, %00111111, %11111000 ; 27
  .byt %00000000, %00000000, %00111111, %11111000 ; 28
  .byt %00000000, %00000000, %00111111, %11111000 ; 29
  .byt %00000000, %00000000, %00111111, %11111000 ; 30
  .byt %00000000, %00000000, %00111111, %11111000 ; 31
  .byt %00000000, %00000000, %00111111, %11111000 ; 32

map_level_1_collision_map_1_second:
  .byt %00000000, %00000011, %11111111, %11111000 ; 1 левая часть экрана
  .byt %00000000, %00000011, %11111111, %11111000 ; 2
  .byt %00000000, %00000011, %11111111, %11111000 ; 3
  .byt %00000000, %00000011, %11111111, %11111000 ; 5
  .byt %00000000, %00000011, %11111111, %11111000 ; 6
  .byt %00000000, %00000011, %11111111, %11111000 ; 7
  .byt %00000000, %00000011, %11111111, %11111000 ; 8
  .byt %00000000, %00000011, %11111111, %11111000 ; 9
  .byt %00000000, %00000011, %11111111, %11111000 ; 10
  .byt %00000000, %00000001, %11111111, %11111000 ; 11
  .byt %00000000, %00000000, %11111111, %11111000 ; 12
  .byt %00000000, %00000000, %01111111, %11111000 ; 13
  .byt %00000000, %00000000, %00111111, %11111000 ; 13
  .byt %00000000, %00000000, %00111111, %11111000 ; 14
  .byt %00000000, %00000000, %01111111, %11100000 ; 15
  .byt %00000000, %00000000, %11111111, %11111000 ; 16
  .byt %00000000, %00000001, %11111111, %11111000 ; 17
  .byt %00000000, %00000011, %11111111, %11111000 ; 18
  .byt %00000000, %00000011, %11111111, %11111000 ; 19
  .byt %00000000, %00000011, %00111111, %11111000 ; 20
  .byt %00000000, %00000011, %00111111, %11111000 ; 21
  .byt %00000000, %00000011, %00111111, %11111000 ; 22
  .byt %00000000, %00000011, %00111111, %11111000 ; 23
  .byt %00000000, %00000011, %00111111, %11111000 ; 24
  .byt %00000000, %00000011, %00111111, %11111000 ; 25
  .byt %00000000, %00000011, %00111111, %11111000 ; 26
  .byt %00000000, %00000000, %00111111, %11111000 ; 27
  .byt %00000000, %00000000, %00011111, %11110000 ; 28
  .byt %00000000, %00000000, %00011111, %11110000 ; 29
  .byt %00000000, %00000000, %00011111, %11110000 ; 30
  .byt %00000000, %00000000, %00011111, %11110000 ; 31
  .byt %00000000, %00000000, %00011111, %11110000 ; 32 правая часть экрана
map_level_1_collision_map_1_second_2:
  .byt %00000000, %00000000, %00011111, %11110000 ; 1
  .byt %00000000, %00000000, %00011111, %11110000 ; 2
  .byt %00000000, %00000000, %00011111, %10110000 ; 3
  .byt %00000000, %00000000, %00011111, %10110000 ; 5
  .byt %00000000, %00000000, %00011111, %10110000 ; 6
  .byt %00000000, %00000000, %00011111, %10110000 ; 7
  .byt %00000000, %00000000, %00011111, %11110000 ; 8
  .byt %00000000, %00000000, %00011111, %11110000 ; 9
  .byt %00000000, %00000000, %00011111, %11110000 ; 10
  .byt %00000000, %00000000, %00011111, %11110000 ; 11
  .byt %00000000, %00000000, %00011111, %11110000 ; 12
  .byt %00000000, %00000000, %00011111, %11110000 ; 13
  .byt %00000000, %00000000, %00011111, %11110000 ; 13
  .byt %00000000, %00000000, %00011111, %11110000 ; 14
  .byt %00000000, %00000000, %00011111, %11110000 ; 15
  .byt %00000000, %00000000, %00011111, %11110000 ; 16
  .byt %00000000, %00000000, %00011111, %11110000 ; 17
  .byt %00000000, %00000000, %00011111, %11110000 ; 18
  .byt %00000000, %00000000, %00011111, %11110000 ; 19
  .byt %00000000, %00000000, %00011111, %11110000 ; 20
  .byt %00000000, %00000000, %00011111, %11110000 ; 21
  .byt %00000000, %00000000, %00011111, %11110000 ; 22
  .byt %00000000, %00000000, %00011111, %11110000 ; 23
  .byt %00000000, %00000000, %00011111, %11110000 ; 24
  .byt %00000000, %00000000, %00011111, %11110000 ; 25
  .byt %00000000, %00000000, %00011111, %11110000 ; 26
  .byt %00000000, %00000000, %00011111, %11110000 ; 27
  .byt %00000000, %00000000, %00011111, %11110000 ; 28
  .byt %00000000, %00000000, %00011111, %11110000 ; 29
  .byt %00000000, %00000000, %00011111, %11110000 ; 30
  .byt %00000000, %00000000, %00011111, %11110000 ; 31
  .byt %00000000, %00000000, %00011111, %11110000 ; 32

collisionMap1:
  .byt <map_level_1_collision_map_1_first, <map_level_1_collision_map_1_second
collisionMap2:
  .byt <map_level_1_collision_map_1_second, <map_level_1_collision_map_1_second_2

.segment "CODE"
    COLLIDE_WATER =     %00000001
    COLLIDE_PLACE =     %00000011
    COLLIDE_BORDER =    %00000010

.proc initVar
    LDA #00
    STA collisionPart

    rts
.endproc

.proc calculateCollisionMap
    LDA scrollPosition
    AND #%00000111
    BEQ skipCalculate

    INC offsetColumn

  skipCalculate:
    RTS
.endproc

.proc calcHeroPosition
    LDA scrollPosition
    CLC
    ADC collideX
    CMP #$FF
    BEQ collisionPartIncrement
    RTS
collisionPartIncrement:
    INC collisionPart
    RTS
.endproc

.proc getCurrentCollisionMap
    LDY collisionPart
    LDA collisionMap1, y
    STA collisionFirstLB

    LDA collisionMap2, y
    STA collisionSecondLB

    RTS
.endproc

.proc collideNo
    LDA #01
    STA isGravity
;    inc heroYCoordinate
;    INC heroYCoordinate
    RTS
.endproc

.proc collideYes
    LDA #00
    STA isGravity
    STA jumpHeight
    STA isJump
    RTS
.endproc

.proc collisionOnMap
    JSR calcHeroPosition
    JSR getCurrentCollisionMap

    LDA offsetColumn
    ASL 
    ASL
    TAY

    LDA collideY
    CLC 
    ADC #18
    LSR
    LSR
    LSR
    LSR
    LSR
    LSR
    CLC
    STA zacumulator

    LDA collideX
    LSR
    LSR
    LSR
    ASL
    ASL
    CLC
    ADC zacumulator
    TAY

    LDA collideY
    CLC
    ADC #18
    LSR
    LSR
    LSR
    AND #7
    TAX

;    LDA scrollPosition
;    LSR
;    LSR
;    LSR
;    ASL
;    ASL
;    STA mapByteOffset
;
;    TYA
;    CLC
;    ADC mapByteOffset
;    TAY

    LDA (collisionFirstLB), y
    AND bit_mask, x
    BEQ firstBitZero
    BNE firstBitNotZero
firstBitZero:
    LDA #%00000000
    STA collideFlag

    JMP secondFlagDetect
firstBitNotZero:
    LDA #%00000001
    STA collideFlag

    JMP secondFlagDetect
secondFlagDetect:
    LDA (collisionSecondLB), y
    AND bit_mask, x
    BEQ secondBitZero
    BNE secondBitNotZero

secondBitZero:
    RTS
secondBitNotZero:
    LDA collideFlag
    EOR #%00000010
    STA collideFlag
    RTS
.endproc
